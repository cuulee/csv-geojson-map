<!DOCTYPE html>
<html>

<head>
  <title>CSV GeoJson Leaflet Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <!--leaflet-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

  <!--Font Awesome CDN-->
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Leaflet Omnivore Plugin GeoJson KML Etc -->
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

  <!--Papa Parse CSV plugin-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>

  <!--account.js-->
  <script src="js/accounting.js"></script>

  <!--End Map CSS and JS-->
</head>
<style>
  body {
    padding: 0;
    margin: 0;
  }

  html,
  body,
  #map {
    height: 100%;
    width: 100%;
  }

  .info {
    position: absolute;
    bottom: 20px;
    left: 20px;
    z-index: 500;
    background: black;
    opacity: 0.3;
    border-radius: 4px;
    padding: 5px;
  }
</style>

<body>
  <div id="map">
    <script>
      var osm, ortho, topo, gray, csv, omnivoreLayer, joinedLayer;

      //Basemaps all served over ssl
      osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      });

      topo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community',
        maxZoom: 20,
        maxNativeZoom: 18,
      });

      ortho = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      });

      gray = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
        subdomains: 'abcd'
      });

      var baseLayers = {
        "Streets": osm,
        "Ortho": ortho,
        "Topo": topo,
        "Grayscale": gray,
      };


      /////////////////////////////
      //----EDIT THIS SECTION----//
      /////////////////////////////
      var center = [39.0021, -83.0099],
        zoom = 9,
        basemap = gray,
        layerName = ["ARC FY 2017"], //need double quotes
        layerUrl = ["data/arc_topojson.json"],
        layerGeomType = "polygon",
        layerFileType = "topojson",
        csvUrl = '',
        //csvUrl = '39yehyefev6qtai/county-economic-status-fy2017.csv',
        dropbox = false,
        joinId = 'FIPS';
      /////////////////////////////
      //----STOP EDITING---------//
      /////////////////////////////

      var map = new L.Map('map', {
        center: center,
        zoom: zoom,
      });

      basemap.addTo(map);

      //Add geometry layer based on file type and extension
      if (layerFileType === 'csv') {
        omnivoreLayer = omnivore.csv(layerUrl[0]);
      }
      if (layerFileType === 'topojson') {
        omnivoreLayer = omnivore.topojson(layerUrl[0]);
      }
      if (layerFileType === 'wkt') {
        omnivoreLayer = omnivore.wkt(layerUrl[0]);
      }
      if (layerFileType === 'geojson') {
        omnivoreLayer = omnivore.geojson(layerUrl[0]);
      }

      omnivoreLayer.on('ready', function() {
        joinedLayer = L.geoJson();
        joinedLayer.addData(omnivoreLayer.toGeoJSON());
        console.log('omnivoreLayer ready');
        joinedLayer.eachLayer(function(layer) {
          var popup = "";
          for (var k in layer.feature.properties) {
            var v = String(layer.feature.properties[k]);
            popup += '<b>' + k + '</b><br>' + v + '<br>' + '<hr style="margin:5px 0px;">';
          };
          layer.bindPopup(popup);
        });
        joinedLayer.addTo(map);
        map.fitBounds(joinedLayer.getBounds());
        var overlays = {
          "Layer": joinedLayer,
        };
        var layerControl = L.control.layers(baseLayers, overlays).addTo(map);
      });

      //Change dropbox url - this is not officially supported in the free version of dropbox
      if (dropbox === true) {
        csv = 'https://dl.dropboxusercontent.com/s/' + csvUrl;
      } else {
        csv = csvUrl
      }

      //If a csv is listed it will be joined to the layerUrl based on the joinId
      if (csvUrl) {

        Papa.parse(csv, {
          download: true,
          header: true,
          complete: function(results) {
                joinedLayer.eachLayer(function(layer){//below code will be executed for each item in the layer
                    var csvData;

                    var geoJoinId = 'layer.feature.properties.' + joinId;

                    if (joinId) {

                      //Function from an awesome person on stack exchange. Look up the CSV data for a row having the same joinId as the layer
                      geoJoinIdString = geoJoinId.toString();
                      var props = layer.feature.properties;

                      csvData = results.data.filter(function(data) {
                        return data.joinId == this;
                      }, geoJoinId);
                    }
                  } //end eachLayer
              });//end joinedLayer

            } //Papa.parse's complete: section over
        }); // Papa.parse function over.
      }
    </script>
</body>
<footer>
</footer>

</html>
